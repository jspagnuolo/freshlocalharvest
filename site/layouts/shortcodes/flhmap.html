<!-- File: site/layouts/shortcodes/flhmap.html -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
<style>
  .flh-map-page{
    margin:0;
    padding:0;
    background:#f3f4f6;
  }

  .flh-wrap{
    max-width:1280px;
    width:calc(100% - 4rem);
    margin:0 auto;
    padding:0 0 2.75rem;
  }
  @media (max-width:1024px){
    .flh-wrap{width:calc(100% - 3rem);}
  }
  @media (max-width:768px){
    .flh-wrap{width:100%;padding:0 1rem 2.5rem;}
  }

  .flh-controls{display:flex;flex-wrap:wrap;gap:1rem 1.25rem;align-items:flex-end;margin:0 0 1.1rem}
  .flh-field{display:flex;flex-direction:column;gap:.35rem;min-width:160px;flex:1}
  .flh-field label{font-size:.8rem;letter-spacing:.02em;font-weight:600;text-transform:uppercase;color:#6b7280}
  .flh-input{padding:.6rem .8rem;border:1px solid #d2d6df;border-radius:.55rem;font-size:1rem;box-shadow:0 1px 2px rgba(15,23,42,.08) inset}
  .flh-clear{align-self:flex-start;padding:.6rem 1rem;border:1px solid #d2d6df;border-radius:.6rem;background:#fff;cursor:pointer;font-weight:600;transition:background .15s,box-shadow .15s}
  .flh-clear:hover{background:#f3f4f6;box-shadow:0 2px 6px rgba(15,23,42,.1)}
  .flh-count{font-size:.9rem;opacity:.75;white-space:nowrap;margin-left:auto;padding-bottom:.4rem}
  @media (max-width:768px){.flh-count{width:100%;margin-left:0;padding-bottom:0;order:99;text-align:right}}

  .flh-content-frame{background:#f8f8f8;border-radius:1.5rem;box-shadow:0 28px 60px rgba(15,23,42,.12);padding:2.25rem 3rem;}
  @media (max-width:1024px){.flh-content-frame{padding:2rem 2.5rem;}}
  @media (max-width:768px){.flh-content-frame{padding:1.75rem 1.25rem;box-shadow:none;border-radius:0;background:transparent;width:100%;}}

  .flh-layout{display:flex;align-items:flex-start;gap:2.25rem}
  .flh-map-pane{flex:1 1 60%;min-width:0}
  .flh-list-pane{flex:0 1 420px;min-width:300px;max-width:460px;max-height:650px;overflow:auto;border-radius:1rem;border:1px solid #e4e7ee;padding:1.1rem 1.25rem;background:#fff;box-shadow:0 12px 32px rgba(15,23,42,.12)}

  #flh-map{width:100%;height:min(70vh,700px);min-height:420px;border-radius:1.1rem;border:1px solid #e4e7ee;overflow:hidden;box-shadow:0 18px 40px rgba(15,23,42,.18)}
  @media (max-width:1150px){
    .flh-layout{flex-direction:column;gap:1.75rem}
    .flh-map-pane{flex:0 0 auto;width:100%;}
    .flh-list-pane{width:100%;max-width:none;max-height:none}
    #flh-map{height:65vh;min-height:360px}
  }
  @media (max-width:700px){
    .flh-map-pane{flex:0 0 auto;width:100%;}
    #flh-map{height:55vh;min-height:320px}
  }

  .flh-results{display:flex;flex-direction:column;gap:.85rem;margin:0;padding:0;list-style:none}
  .flh-result{border:1px solid #e7e9f0;border-radius:.9rem;padding:.85rem 1rem;background:#fff;text-align:left;cursor:pointer;transition:box-shadow .15s,border-color .15s}
  .flh-result:hover{box-shadow:0 6px 18px rgba(15,23,42,.1)}
  .flh-result--active{border-color:#2a7f62;box-shadow:0 0 0 2px rgba(42,127,98,.2)}
  .flh-result h3{margin:0;font-size:1rem;line-height:1.4}
  .flh-result-address{margin:.35rem 0;font-size:.9rem;color:#4b5563}
  .flh-result-desc{margin:.2rem 0 0;font-size:.85rem;color:#616d80}
  .flh-result-distance{margin:.3rem 0 0;font-size:.82rem;color:#2563eb;font-weight:600}
  .flh-badges{display:flex;flex-wrap:wrap;gap:.35rem;margin-top:.45rem}
  .flh-badge{font-size:.72rem;padding:.18rem .45rem;border-radius:.4rem;background:#eef2ff;color:#31427a;font-weight:600}
  .flh-results-message{font-size:.9rem;color:#4b5563;margin-bottom:.75rem}
  .flh-results-hint{font-size:.85rem;color:#6b7280;margin-top:.5rem}

  .snap-pill{display:inline-block;margin-top:.35rem;padding:.2rem .45rem;font-size:.75rem;border-radius:.4rem;background:#e7f5e7;border:1px solid #b9e0b9}
</style>

<div class="flh-wrap">
  <div class="flh-content-frame">
  <div class="flh-controls">
    <div class="flh-field">
      <label for="flh-city">City</label>
      <input id="flh-city" class="flh-input" type="search" placeholder="e.g., Miami" autocomplete="off">
    </div>
    <div class="flh-field" style="max-width:120px">
      <label for="flh-state">State</label>
      <input id="flh-state" class="flh-input" type="text" placeholder="FL" maxlength="2" autocomplete="off">
    </div>
    <div class="flh-field" style="max-width:140px">
      <label for="flh-zip">ZIP</label>
      <input id="flh-zip" class="flh-input" type="search" placeholder="30303" inputmode="numeric" pattern="[0-9]*" maxlength="10" autocomplete="off">
    </div>
    <div class="flh-field">
      <label for="flh-name">Market Name / Keyword</label>
      <input id="flh-name" class="flh-input" type="search" placeholder="Market name or programs" autocomplete="off">
    </div>
    <button id="flh-clear" class="flh-clear" type="button">Clear Filters</button>
    <span id="flh-count" class="flh-count" aria-live="polite"></span>
  </div>
  <div class="flh-layout">
    <div class="flh-map-pane"><div id="flh-map"></div></div>
    <div class="flh-list-pane" aria-live="polite">
      <div id="flh-list-message" class="flh-results-message"></div>
      <div id="flh-results" class="flh-results" role="list"></div>
      <div id="flh-results-hint" class="flh-results-hint"></div>
    </div>
  </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
(function(){
  const MAP_ID = "flh-map";
  const DEFAULT_CENTER = [39.5, -98.35];
  const DEFAULT_ZOOM = 4;
  const MAX_RESULTS = 200;
  const ZIP_RADIUS_MILES = 30;
  const CITY_RADIUS_MILES = 30;
  const NEAREST_RESULTS_LIMIT = 75;
  const USER_LOCATION_FALLBACK_ZOOM = 8;

  const MAP_URL_RAW         = {{ (.Get "data"           | default "/data/markets.map.json")        | jsonify }};
  const SEARCH_URL_RAW      = {{ (.Get "search"         | default "/data/markets.search.json")      | jsonify }};
  const ZIP_URL_RAW         = {{ (.Get "zip_centroids"  | default "/data/zip.centroids.json")       | jsonify }};
  const CITY_URL_RAW        = {{ (.Get "city_centroids" | default "/data/city.centroids.json")      | jsonify }};
  const USER_LOCATION_URL_RAW = {{ (.Get "user_location" | default "/api/user-location")            | jsonify }};

  const $city = document.getElementById('flh-city');
  const $state = document.getElementById('flh-state');
  const $zip = document.getElementById('flh-zip');
  const $name = document.getElementById('flh-name');
  const $clear = document.getElementById('flh-clear');
  const $count = document.getElementById('flh-count');
  const $results = document.getElementById('flh-results');
  const $message = document.getElementById('flh-list-message');
  const $hint = document.getElementById('flh-results-hint');

  function normalizeUrl(u){
    if (u == null) return '';
    u = String(u).trim().replace(/^["']+|["']+$/g, "");
    return u.startsWith('/') ? u : `/${u}`;
  }
  const MAP_URL = normalizeUrl(MAP_URL_RAW);
  const SEARCH_URL = normalizeUrl(SEARCH_URL_RAW);
  const ZIP_URL = normalizeUrl(ZIP_URL_RAW);
  const CITY_URL = normalizeUrl(CITY_URL_RAW);
  const USER_LOCATION_URL = normalizeUrl(USER_LOCATION_URL_RAW);

  let zipCentroids = {};
  let cityCentroids = {};
  let userLocation = null;
  let userMarker = null;

  const STATES = {
    "alabama":"AL","alaska":"AK","arizona":"AZ","arkansas":"AR","california":"CA","colorado":"CO","connecticut":"CT","delaware":"DE",
    "district of columbia":"DC","florida":"FL","georgia":"GA","hawaii":"HI","idaho":"ID","illinois":"IL","indiana":"IN","iowa":"IA",
    "kansas":"KS","kentucky":"KY","louisiana":"LA","maine":"ME","maryland":"MD","massachusetts":"MA","michigan":"MI","minnesota":"MN",
    "mississippi":"MS","missouri":"MO","montana":"MT","nebraska":"NE","nevada":"NV","new hampshire":"NH","new jersey":"NJ",
    "new mexico":"NM","new york":"NY","north carolina":"NC","north dakota":"ND","ohio":"OH","oklahoma":"OK","oregon":"OR",
    "pennsylvania":"PA","rhode island":"RI","south carolina":"SC","south dakota":"SD","tennessee":"TN","texas":"TX","utah":"UT",
    "vermont":"VT","virginia":"VA","washington":"WA","west virginia":"WV","wisconsin":"WI","wyoming":"WY","puerto rico":"PR"
  };
  const STATE_CODES = new Set(Object.values(STATES));
  const STATE_NAME_BY_CODE = Object.fromEntries(Object.entries(STATES).map(([name, code]) => [code, name]));

  const map = L.map(MAP_ID, { scrollWheelZoom: false });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OSM'}).addTo(map);
  map.setView(DEFAULT_CENTER, DEFAULT_ZOOM);

  const markersGroup = L.featureGroup().addTo(map);
  const records = [];
  const recordById = new Map();
  let totalRecords = 0;
  let activeId = null;

  const escapeHtml = (str) => String(str ?? '').replace(/[&<>"']/g, (ch) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]));
  const normalizeWhitespace = (value) => String(value || '').toLowerCase().replace(/[^a-z0-9\s]/g, ' ').replace(/\s+/g, ' ').trim();
  const toTitleCase = (value) => String(value || '').replace(/\b\w/g, (ch) => ch.toUpperCase());
  const digitsOnly = (value) => String(value || '').replace(/[^0-9]/g, '');
  const debounce = (fn, ms=150) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; };
  const EARTH_RADIUS_MILES = 3958.7613;

  function haversineMiles(lat1, lon1, lat2, lon2){
    const toRad = (deg) => deg * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return EARTH_RADIUS_MILES * c;
  }

  function normalizeCentroidDataset(raw){
    if (!raw) return {};
    if (Array.isArray(raw)){
      const out = {};
      for (const item of raw){
        if (item && item.zip){
          const code = digitsOnly(item.zip).padStart(5, '0');
          if (Array.isArray(item.coords) && item.coords.length === 2){
            out[code] = item.coords;
          } else if (typeof item.lat === 'number' && typeof item.lon === 'number'){
            out[code] = [item.lat, item.lon];
          }
        }
      }
      return out;
    }
    return raw;
  }

  function buildLocationLabel(data){
    if (!data) return '';
    const parts = [];
    if (data.city){
      parts.push(toTitleCase(data.city));
    }
    if (data.region){
      parts.push(data.region);
    }
    if (!parts.length && data.country){
      parts.push(data.country);
    }
    if (data.postalCode && parts.length){
      parts[parts.length - 1] = `${parts[parts.length - 1]} ${data.postalCode}`.trim();
    }
    return parts.join(', ');
  }

  function ensureUserMarker(origin){
    if (!origin || !Number.isFinite(origin.lat) || !Number.isFinite(origin.lon)) return;
    const point = [origin.lat, origin.lon];
    if (!userMarker){
      userMarker = L.circleMarker(point, {
        radius: 8,
        color: '#1d4ed8',
        weight: 2,
        fillColor: '#3b82f6',
        fillOpacity: 0.85,
        opacity: 0.9,
        interactive: false
      }).addTo(map);
      userMarker.bindTooltip('Your approximate location');
    } else {
      userMarker.setLatLng(point);
    }
  }

  function fetchUserLocation(){
    if (!USER_LOCATION_URL) return Promise.resolve(null);
    return fetch(USER_LOCATION_URL, { cache: 'no-store', credentials: 'omit' })
      .then(res => res.ok ? res.json() : null)
      .then(body => {
        if (!body) return null;
        const lat = Number(body.latitude ?? body.lat ?? body.coords?.latitude);
        const lon = Number(body.longitude ?? body.lon ?? body.coords?.longitude);
        if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
        const location = {
          lat,
          lon,
          city: body.city || null,
          region: body.region || null,
          country: body.country || null,
          postalCode: body.postalCode || null,
          source: body.source || 'cloudflare-headers'
        };
        location.label = body.label || buildLocationLabel(location);
        return location;
      })
      .catch(() => null);
  }

  function showNearestMarkets(origin){
    if (!origin || !Number.isFinite(origin.lat) || !Number.isFinite(origin.lon) || !records.length) return;
    const candidates = [];
    for (const entry of records){
      const distance = haversineMiles(origin.lat, origin.lon, entry.data.latitude, entry.data.longitude);
      if (!Number.isFinite(distance)) continue;
      entry.data.distanceMiles = distance;
      entry.data.distanceSource = 'user';
      candidates.push(entry);
    }

    const sorted = candidates.slice().sort((a, b) => {
      const da = a.data.distanceMiles;
      const db = b.data.distanceMiles;
      return da - db;
    });

    const limit = Math.min(MAX_RESULTS, NEAREST_RESULTS_LIMIT);
    const visible = sorted.slice(0, limit);

    markersGroup.clearLayers();
    for (const entry of visible){
      markersGroup.addLayer(entry.marker);
    }

    const filters = {
      nearestMode: true,
      nearestLabel: origin.label,
      distanceMode: 'user',
      nearestTotal: candidates.length,
      nearestShown: visible.length
    };

    renderCount(visible.length, totalRecords, true);
    renderList(visible, candidates.length, filters);

    ensureUserMarker(origin);

    try {
      if (markersGroup.getLayers().length){
        let bounds = markersGroup.getBounds();
        if (userMarker){
          bounds = bounds.extend(userMarker.getLatLng());
        }
        map.fitBounds(bounds.pad(0.12));
      } else if (userMarker){
        map.setView(userMarker.getLatLng(), USER_LOCATION_FALLBACK_ZOOM);
      }
    } catch (err) {
      if (userMarker){
        map.setView(userMarker.getLatLng(), USER_LOCATION_FALLBACK_ZOOM);
      }
    }

    const url = new URL(location);
    url.searchParams.delete('city');
    url.searchParams.delete('state');
    url.searchParams.delete('zip');
    url.searchParams.delete('q');
    history.replaceState(null, '', url);
  }

  function parseCityInput(raw){
    const original = (raw || '').trim();
    const normalizedFull = normalizeWhitespace(original);
    if (!normalizedFull){
      return { normalizedFull: '', cityKey: '', tokens: [], stateHint: '', displayCity: '' };
    }

    const tokens = normalizedFull.split(' ').filter(Boolean);
    if (!tokens.length){
      return { normalizedFull: '', cityKey: '', tokens: [], stateHint: '', displayCity: '' };
    }

    let cityTokens = tokens.slice();
    let stateHint = '';
    const last = tokens[tokens.length - 1];
    if (last && last.length === 2 && /^[a-z]{2}$/.test(last)){
      stateHint = last.toUpperCase();
      cityTokens = tokens.slice(0, -1);
      if (!cityTokens.length){
        cityTokens = tokens.slice();
        stateHint = '';
      }
    }

    const cityKey = cityTokens.join(' ');
    const displayCity = toTitleCase(cityKey || normalizedFull);
    return {
      normalizedFull,
      cityKey,
      tokens: cityTokens,
      stateHint,
      displayCity
    };
  }

  function resolveCityTarget(filters){
    if (!filters.cityNormalized){
      return null;
    }
    const attempts = [];
    if (filters.stateNormalized){
      attempts.push(`${filters.cityNormalized}|${filters.stateNormalized}`);
    }
    if (!filters.stateNormalized && filters.cityStateHint){
      attempts.push(`${filters.cityNormalized}|${filters.cityStateHint}`);
    }
    attempts.push(filters.cityNormalized);

    for (const key of attempts){
      const centroid = cityCentroids[key];
      if (Array.isArray(centroid) && centroid.length === 2){
        const [lat, lon] = centroid;
        const latNum = Number(lat);
        const lonNum = Number(lon);
        if (Number.isFinite(latNum) && Number.isFinite(lonNum)){
          return {
            lat: latNum,
            lon: lonNum,
            radius: CITY_RADIUS_MILES,
            label: filters.cityLabel || toTitleCase(filters.cityNormalized),
            key
          };
        }
      }
    }
    return null;
  }

  const toNum = (value) => {
    const n = Number(value);
    return Number.isFinite(n) ? n : NaN;
  };
  const clampUS = (lat, lng) => lat >= 18 && lat <= 72 && lng <= -50 && lng >= -170;

  function parseAddressParts(rec){
    return {
      name: rec.listing_name || rec.name || '',
      organization: rec.organization || '',
      street: rec.street || '',
      city: rec.city || '',
      state: (rec.state || '').toUpperCase(),
      zip: rec.zip || ''
    };
  }

  function renderPopup(data){
    const pieces = [];
    const programs = [];
    if (data.program_snap) programs.push('SNAP/EBT');
    if (data.program_wic) programs.push('WIC');
    if (data.program_wic_fmnp) programs.push('WIC FMNP');
    if (data.program_senior_fmnp) programs.push('Senior FMNP');
    if (data.program_incentives) programs.push('Incentives');

    pieces.push(`<strong>${escapeHtml(data.name || 'Farmers Market')}</strong>`);
    if (data.full_address) pieces.push(`<div>${escapeHtml(data.full_address)}</div>`);
    if (data.snap_acceptance) pieces.push(`<div class="snap-pill">${escapeHtml(data.snap_acceptance)}</div>`);
    if (data.location_desc) pieces.push(`<div style="margin-top:4px;font-size:12px;line-height:1.4;">${escapeHtml(data.location_desc)}</div>`);
    if (!data.location_desc && data.listing_desc) {
      pieces.push(`<div style="margin-top:4px;font-size:12px;line-height:1.4;">${escapeHtml(data.listing_desc)}</div>`);
    }
    if (programs.length) {
      pieces.push(`<div style="margin-top:6px;font-size:12px;">Programs: ${escapeHtml(programs.join(', '))}</div>`);
    }
    return pieces.join('');
  }

  function renderBadgeList(data){
    const badges = [];
    if (data.program_snap) badges.push('SNAP/EBT');
    if (data.program_wic) badges.push('WIC');
    if (data.program_wic_fmnp) badges.push('WIC FMNP');
    if (data.program_senior_fmnp) badges.push('Senior FMNP');
    if (data.program_incentives) badges.push('Incentives');
    if (data.snap_central_booth) badges.push('Central Booth');
    if (data.snap_vendor_pos) badges.push('Vendor POS');
    if (data.snap_acceptance && !badges.includes('SNAP/EBT')) badges.push('SNAP/EBT');
    return badges.map(b => `<span class="flh-badge">${escapeHtml(b)}</span>`).join('');
  }

  function renderResultCard(record){
    const d = record.data;
    const address = d.full_address || [d.street, d.city, d.state, d.zip].filter(Boolean).join(', ');
    const desc = d.location_desc || d.listing_desc || '';
    const badges = renderBadgeList(d);
    const distance = typeof d.distanceMiles === 'number' ? `<p class="flh-result-distance">${d.distanceMiles.toFixed(1)} miles away</p>` : '';
    return `
      <div class="flh-result" role="listitem" tabindex="0" data-id="${record.id}">
        <h3>${escapeHtml(d.name || 'Farmers Market')}</h3>
        ${address ? `<p class="flh-result-address">${escapeHtml(address)}</p>` : ''}
        ${desc ? `<p class="flh-result-desc">${escapeHtml(desc)}</p>` : ''}
        ${distance}
        ${badges ? `<div class="flh-badges">${badges}</div>` : ''}
      </div>
    `;
  }

  function renderCount(shown, total, hasFilters){
    if (!$count) return;
    if (!hasFilters){
      $count.textContent = total ? `${total.toLocaleString()} markets available` : '';
    } else {
      $count.textContent = `${shown.toLocaleString()} of ${total.toLocaleString()}`;
    }
  }

  function clearHighlight(){
    if (!activeId) return;
    const prev = $results.querySelector(`[data-id="${activeId}"]`);
    if (prev) prev.classList.remove('flh-result--active');
    activeId = null;
  }

  function highlightResult(id, opts={scroll:true}){
    if (activeId === id) return;
    clearHighlight();
    const el = $results.querySelector(`[data-id="${id}"]`);
    if (el){
      el.classList.add('flh-result--active');
      if (opts.scroll) el.scrollIntoView({block:'nearest', behavior:'smooth'});
    }
    activeId = id;
  }

  function focusRecord(id){
    const entry = recordById.get(id);
    if (!entry) return;
    if (!markersGroup.hasLayer(entry.marker)) {
      markersGroup.addLayer(entry.marker);
    }
    const latLng = entry.marker.getLatLng();
    const targetZoom = Math.max(map.getZoom(), 9);
    map.setView(latLng, targetZoom, { animate: true });
    entry.marker.openPopup();
    highlightResult(id);
  }

  function hasFilters(filters){
    return Boolean(
      (filters.cityNormalized && filters.cityNormalized.length) ||
      (filters.stateNormalized && filters.stateNormalized.length) ||
      (filters.zipNormalized && filters.zipNormalized.length) ||
      (filters.nameTokens && filters.nameTokens.length)
    );
  }

  function renderList(matches, matchCount, filters){
    clearHighlight();
    const nearestMode = Boolean(filters.nearestMode);

    if (!nearestMode && !hasFilters(filters)){
      $results.innerHTML = '';
      $message.textContent = totalRecords ? `Type a city, state, ZIP, or market name to explore ${totalRecords.toLocaleString()} markets.` : '';
      $hint.textContent = 'Try “miami”, “ohio”, “albany ny”, or a ZIP such as “30303”.';
      return;
    }

    if (!matchCount){
      $results.innerHTML = '';
      if (nearestMode){
        $message.textContent = 'No markets found near your location.';
        $hint.textContent = 'Try entering a city or ZIP code to look elsewhere.';
      } else {
        const summaryParts = [];
        if (filters.cityRaw) summaryParts.push(`city “${escapeHtml(filters.cityRaw)}”`);
        if (filters.stateRaw) summaryParts.push(`state ${escapeHtml(filters.stateRaw.toUpperCase())}`);
        if (filters.zipRaw) summaryParts.push(`ZIP ${escapeHtml(filters.zipRaw)}`);
        if (filters.nameRaw) summaryParts.push(`keywords “${escapeHtml(filters.nameRaw)}”`);
        const summary = summaryParts.join(', ') || 'your filters';
        $message.textContent = `No markets found for ${summary}.`;
        $hint.textContent = 'Adjust the filters or try a nearby city/ZIP code.';
      }
      return;
    }

    const cards = matches.map(renderResultCard).join('');
    $results.innerHTML = cards;

    if (nearestMode){
      $message.textContent = matchCount === 1
        ? '1 market near you'
        : `${Math.min(matchCount, matches.length).toLocaleString()} markets near you`;
    } else {
      $message.textContent = matchCount === 1
        ? '1 market found'
        : `${matchCount.toLocaleString()} markets found`;
    }

    let hintCopy = '';
    if (filters.distanceMode === 'zip' && filters.zipLabel){
      const zipLabel = escapeHtml(filters.zipLabel);
      hintCopy = `Within ${ZIP_RADIUS_MILES} miles of ZIP ${zipLabel}.`;
      if (matchCount > matches.length){
        hintCopy += ` Showing the first ${matches.length} matches.`;
      }
    } else if (filters.distanceMode === 'city' && filters.cityTargetLabel){
      const cityLabel = escapeHtml(filters.cityTargetLabel);
      hintCopy = `Within ${CITY_RADIUS_MILES} miles of ${cityLabel}.`;
      if (matchCount > matches.length){
        hintCopy += ` Showing the first ${matches.length} matches.`;
      }
    } else if (filters.distanceMode === 'user'){
      const label = filters.nearestLabel ? escapeHtml(filters.nearestLabel) : 'your location';
      hintCopy = `Nearest markets to ${label}.`;
      if (filters.nearestTotal && filters.nearestTotal > matches.length){
        hintCopy += ` Showing the first ${matches.length} results.`;
      }
    } else if (matchCount > matches.length){
      hintCopy = `Showing the first ${matches.length} results. Narrow your search for a shorter list.`;
    }
    $hint.textContent = hintCopy;
  }

  function getFilters(){
    const cityRaw = ($city.value || '').trim();
    const stateRaw = ($state.value || '').trim();
    const zipRaw = ($zip.value || '').trim();
    const nameRaw = ($name.value || '').trim();

    const cityParts = parseCityInput(cityRaw);
    const cityNormalized = cityParts.cityKey;
    const cityTokens = cityParts.tokens;
    const cityStateHint = cityParts.stateHint;
    const cityDisplay = cityParts.displayCity;

    const stateFromInput = stateRaw.toUpperCase();
    const stateNormalized = stateFromInput || cityStateHint || '';
    const stateParam = stateRaw ? stateFromInput : (cityStateHint || '');
    const cityLabel = cityDisplay
      ? (stateNormalized ? `${cityDisplay}, ${stateNormalized}` : cityDisplay)
      : (cityRaw || '');

    return {
      cityRaw,
      stateRaw,
      zipRaw,
      nameRaw,
      cityNormalized,
      cityTokens,
      cityStateHint,
      cityLabel,
      stateNormalized,
      stateParam,
      zipNormalized: digitsOnly(zipRaw),
      nameTokens: normalizeWhitespace(nameRaw).split(' ').filter(Boolean)
    };
  }

  function matchesFilters(data, filters, radiusOptions = {}){
    if (filters.stateNormalized && data.stateNormalized && data.stateNormalized !== filters.stateNormalized) return false;

    if (filters.zipNormalized && !radiusOptions.zipTarget) return false;

    const requiresCityMatch = Boolean(filters.cityNormalized && !radiusOptions.cityTarget);
    if (requiresCityMatch){
      if (!data.cityNormalized) return false;
      if (!filters.cityTokens.every(tok => data.cityNormalized.includes(tok))) return false;
    }

    if (filters.nameTokens.length && !filters.nameTokens.every(tok => data.haystackNormalized.includes(tok))) return false;

    const targets = [];
    if (radiusOptions.zipTarget){
      targets.push({ ...radiusOptions.zipTarget, type: 'zip' });
    } else if (radiusOptions.cityTarget){
      targets.push({ ...radiusOptions.cityTarget, type: 'city' });
    }

    if (targets.length){
      const target = targets[0];
      const distance = haversineMiles(target.lat, target.lon, data.latitude, data.longitude);
      if (!Number.isFinite(distance) || distance > target.radius) return false;
      data.distanceMiles = distance;
      data.distanceSource = target.type;
    } else if (Object.prototype.hasOwnProperty.call(data, 'distanceMiles')){
      delete data.distanceMiles;
      delete data.distanceSource;
    }

    return true;
  }

  function applyFilters(){
    const filters = getFilters();
    const filtersActive = hasFilters(filters);

    let zipTarget = null;
    if (filters.zipNormalized){
      const key = filters.zipNormalized.padStart(5, '0');
      const prefixKey = key.slice(0, 3);
      const rawCentroid = zipCentroids[key] || zipCentroids[filters.zipNormalized] || zipCentroids[prefixKey];
      if (Array.isArray(rawCentroid) && rawCentroid.length === 2){
        const [lat, lon] = rawCentroid;
        const latNum = Number(lat);
        const lonNum = Number(lon);
        if (Number.isFinite(latNum) && Number.isFinite(lonNum)){
          zipTarget = { lat: latNum, lon: lonNum, radius: ZIP_RADIUS_MILES, label: filters.zipRaw || key, key };
        }
      }
      if (!zipTarget){
        const fallback = records.find(r => r.data.zipNormalized === filters.zipNormalized);
        if (fallback){
          zipTarget = {
            lat: fallback.data.latitude,
            lon: fallback.data.longitude,
            radius: ZIP_RADIUS_MILES,
            label: filters.zipRaw || fallback.data.zip || filters.zipNormalized,
            key: 'record'
          };
        }
      }
    }
    if (zipTarget){
      filters.zipLabel = zipTarget.label;
    }

    const cityTarget = resolveCityTarget(filters);
    if (cityTarget){
      filters.cityTargetLabel = cityTarget.label;
    }

    const radiusOptions = { zipTarget, cityTarget };

    markersGroup.clearLayers();

    if (!filtersActive){
      if (userLocation){
        showNearestMarkets(userLocation);
      } else {
        renderCount(0, totalRecords, false);
        renderList([], 0, filters);
        map.setView(DEFAULT_CENTER, DEFAULT_ZOOM);
        const url = new URL(location);
        url.searchParams.delete('city');
        url.searchParams.delete('state');
        url.searchParams.delete('zip');
        url.searchParams.delete('q');
        history.replaceState(null, '', url);
      }
      return;
    }

    let matchCount = 0;
    const visible = [];

    for (const entry of records){
      if (matchesFilters(entry.data, filters, radiusOptions)){
        matchCount++;
        if (visible.length < MAX_RESULTS){
          visible.push(entry);
          markersGroup.addLayer(entry.marker);
        }
      }
    }

    const distanceSortActive = Boolean(zipTarget || cityTarget);
    if (distanceSortActive){
      visible.sort((a, b) => {
        const da = a.data.distanceMiles ?? Number.POSITIVE_INFINITY;
        const db = b.data.distanceMiles ?? Number.POSITIVE_INFINITY;
        return da - db;
      });
    }

    renderCount(matchCount, totalRecords, filtersActive);
    filters.distanceMode = zipTarget ? 'zip' : (cityTarget ? 'city' : null);
    renderList(visible, matchCount, filters);

    if (zipTarget){
      if (markersGroup.getLayers().length){
        try {
          map.fitBounds(markersGroup.getBounds().pad(0.08));
        } catch (err) {}
      } else {
        map.setView([zipTarget.lat, zipTarget.lon], 10);
      }
    } else if (cityTarget){
      if (markersGroup.getLayers().length){
        try {
          map.fitBounds(markersGroup.getBounds().pad(0.08));
        } catch (err) {}
      } else {
        map.setView([cityTarget.lat, cityTarget.lon], 9);
      }
    } else {
      if (markersGroup.getLayers().length){
        try {
          map.fitBounds(markersGroup.getBounds().pad(0.08));
        } catch (err) {}
      } else {
        map.setView(DEFAULT_CENTER, DEFAULT_ZOOM);
      }
    }

    const url = new URL(location);
    filters.cityRaw ? url.searchParams.set('city', filters.cityRaw) : url.searchParams.delete('city');
    filters.stateParam ? url.searchParams.set('state', filters.stateParam) : url.searchParams.delete('state');
    filters.zipRaw ? url.searchParams.set('zip', filters.zipRaw) : url.searchParams.delete('zip');
    filters.nameRaw ? url.searchParams.set('q', filters.nameRaw) : url.searchParams.delete('q');
    history.replaceState(null, '', url);
  }

  function hydrate(){
    Promise.all([
      fetch(MAP_URL, { cache: 'no-store' }).then(r => r.json()),
      fetch(SEARCH_URL, { cache: 'no-store' }).then(r => r.json()),
      fetch(ZIP_URL, { cache: 'no-store' }).then(r => r.ok ? r.json() : {}).catch(() => ({})),
      fetch(CITY_URL, { cache: 'no-store' }).then(r => r.ok ? r.json() : {}).catch(() => ({}))
    ]).then(([mapData, searchData, zipData, cityData]) => {
      zipCentroids = normalizeCentroidDataset(zipData);
      cityCentroids = normalizeCentroidDataset(cityData);
      const mapRows = Array.isArray(mapData) ? mapData : (mapData.rows || mapData.data || []);
      const searchRows = Array.isArray(searchData) ? searchData : (searchData.rows || searchData.data || []);

      const searchById = new Map();
      for (const row of searchRows){
        const id = String(row.listing_id || row.id || '').trim();
        if (id) searchById.set(id, row);
      }

      for (const rec of mapRows){
        const id = String(rec.listing_id || rec.id || '').trim();
        if (!id) continue;

        let lat = toNum(rec.latitude ?? rec.lat ?? rec.location_y);
        let lng = toNum(rec.longitude ?? rec.lon ?? rec.location_x);

        if (!clampUS(lat, lng) && clampUS(lng, lat)){
          const tmp = lat; lat = lng; lng = tmp;
        }
        if (!Number.isFinite(lat) || !Number.isFinite(lng) || !clampUS(lat, lng)) continue;

        const searchRow = searchById.get(id) || {};

        const combined = {
          id,
          name: rec.listing_name || searchRow.listing_name || rec.name || 'Farmers Market',
          organization: searchRow.organization ?? rec.organization ?? '',
          street: searchRow.street ?? rec.street ?? '',
          city: searchRow.city ?? rec.city ?? '',
          state: (searchRow.state ?? rec.state ?? '').toUpperCase(),
          zip: searchRow.zip ?? rec.zip ?? '',
          zip_lat: searchRow.zip_lat ?? rec.zip_lat ?? null,
          zip_lon: searchRow.zip_lon ?? rec.zip_lon ?? null,
          full_address: searchRow.full_address ?? rec.full_address ?? rec.location_address ?? '',
          location_desc: rec.location_desc ?? searchRow.location_desc ?? '',
          listing_desc: rec.listing_desc ?? searchRow.listing_desc ?? '',
          snap_acceptance: rec.snap_acceptance ?? searchRow.snap_acceptance ?? '',
          program_snap: Boolean(searchRow.program_snap ?? rec.program_snap),
          program_wic: Boolean(searchRow.program_wic ?? rec.program_wic),
          program_wic_fmnp: Boolean(searchRow.program_wic_fmnp ?? rec.program_wic_fmnp),
          program_senior_fmnp: Boolean(searchRow.program_senior_fmnp ?? rec.program_senior_fmnp),
          program_incentives: Boolean(searchRow.program_incentives ?? rec.program_incentives),
          snap_central_booth: Boolean(searchRow.snap_central_booth ?? rec.snap_central_booth),
          snap_vendor_pos: Boolean(searchRow.snap_vendor_pos ?? rec.snap_vendor_pos),
          longitude: lng,
          latitude: lat,
          search_state: (searchRow.search_state ?? rec.state ?? '').toUpperCase(),
          search_city: (searchRow.search_city ?? (rec.city || '')).toLowerCase(),
          search_zip: (searchRow.search_zip ?? rec.zip ?? '').slice(0, 5),
          search_haystack: (searchRow.search_haystack || '').toLowerCase()
        };

        if (!combined.search_haystack){
          const sourcePieces = [
            combined.name,
            combined.organization,
            combined.street,
            combined.city,
            combined.state,
            STATE_NAME_BY_CODE[combined.state] || '',
            combined.zip,
            combined.location_desc,
            combined.listing_desc
          ];
          combined.search_haystack = sourcePieces.filter(Boolean).join(' ').toLowerCase();
        }

        if (combined.state && STATE_NAME_BY_CODE[combined.state]){
          combined.state_name = STATE_NAME_BY_CODE[combined.state].replace(/\b\w/g, ch => ch.toUpperCase());
          if (!combined.search_haystack.includes(STATE_NAME_BY_CODE[combined.state])){
            combined.search_haystack += ` ${STATE_NAME_BY_CODE[combined.state]}`;
          }
        } else {
          combined.state_name = combined.state;
        }

        combined.cityNormalized = normalizeWhitespace(combined.search_city || combined.city);
        combined.stateNormalized = (combined.search_state || '').toUpperCase();
        combined.zipNormalized = digitsOnly(combined.search_zip || combined.zip);
        combined.haystackNormalized = normalizeWhitespace(combined.search_haystack || '');

        const marker = L.marker([combined.latitude, combined.longitude], { title: combined.name });
        marker.bindPopup(renderPopup(combined));
        marker.on('click', () => highlightResult(id));

        const entry = { id, marker, data: combined };
        records.push(entry);
        recordById.set(id, entry);
      }

      totalRecords = records.length;
      applyFilters();

      fetchUserLocation().then((loc) => {
        if (!loc) return;
        userLocation = loc;
        ensureUserMarker(loc);
        const currentFilters = getFilters();
        if (!hasFilters(currentFilters)){
          showNearestMarkets(loc);
        }
      });
    }).catch(err => {
      console.error('Failed to load market data', err);
      $message.textContent = 'Unable to load markets right now. Please refresh the page.';
    });
  }

  const params = new URL(location).searchParams;
  if (params.get('city')) $city.value = params.get('city');
  if (params.get('state')) $state.value = params.get('state');
  if (params.get('zip')) $zip.value = params.get('zip');
  if (params.get('q')) $name.value = params.get('q');

  hydrate();

  const applyFiltersDebounced = debounce(applyFilters, 120);
  [$city, $state, $zip, $name].forEach(el => {
    el.addEventListener('input', applyFiltersDebounced);
    el.addEventListener('change', applyFilters);
    el.addEventListener('keydown', (e) => {
      if (e.key === 'Enter'){
        e.preventDefault();
        applyFilters();
      }
    });
  });
  $clear.addEventListener('click', () => {
    $city.value = '';
    $state.value = '';
    $zip.value = '';
    $name.value = '';
    applyFilters();
    $city.focus();
  });

  $results.addEventListener('click', (e) => {
    const card = e.target.closest('[data-id]');
    if (!card) return;
    focusRecord(card.dataset.id);
  });
  $results.addEventListener('keydown', (e) => {
    if ((e.key === 'Enter' || e.key === ' ') && e.target.matches('[data-id]')){
      e.preventDefault();
      focusRecord(e.target.dataset.id);
    }
  });
})();
</script>
