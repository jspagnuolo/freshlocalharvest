<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FreshLocalHarvest — Markets</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root { --sidebar: 360px; }
    html, body { height: 100%; margin: 0; font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #app { display: grid; grid-template-columns: var(--sidebar) 1fr; height: 100%; }
    #sidebar { border-right: 1px solid #e5e5e5; display: flex; flex-direction: column; min-width: 280px; }
    #controls { padding: 10px; position: sticky; top: 0; background: #fff; z-index: 10; border-bottom: 1px solid #eee; }
    #controls .row { display: flex; gap: 8px; align-items: center; margin: 6px 0; flex-wrap: wrap; }
    #controls input[type="text"] { flex: 1 1 auto; padding: 6px 8px; border: 1px solid #ccc; border-radius: 6px; }
    #controls select, #controls input[type="range"], #controls button { padding: 6px 8px; border: 1px solid #ccc; border-radius: 6px; }
    #controls button { background: #f6f6f6; cursor: pointer; }
    #list { overflow: auto; padding: 8px; }
    .item { padding: 8px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 8px; cursor: pointer; }
    .item:hover { background: #fafafa; }
    .item.active { outline: 2px solid #4c9ffe; background: #f3f8ff; }
    .name { font-weight: 600; margin-bottom: 2px; }
    .meta { color: #555; font-size: 12px; }
    .badges { display: inline-flex; gap: 6px; margin-left: 6px; }
    .badge { font-size: 11px; padding: 2px 6px; border-radius: 999px; border: 1px solid #ddd; background: #fff; }
    .badge.snap-yes { border-color: #17803d; color: #17803d; }
    .badge.snap-no { border-color: #9e3a3a; color: #9e3a3a; }
    .badge.snap-unk { border-color: #999; color: #666; }
    #count { color: #444; font-size: 12px; }
    #map { height: 100%; }
    /* small screens: stack */
    @media (max-width: 900px) {
      #app { grid-template-columns: 1fr; }
      #sidebar { height: 45vh; }
      #map { height: 55vh; }
    }
  </style>
</head>
<body>
  <div id="app">
    <aside id="sidebar">
      <div id="controls">
        <div class="row">
          <input id="q" type="text" placeholder="Search name/city…" />
          <button id="apply">Search</button>
        </div>
        <div class="row">
          <label><input type="checkbox" id="snap"> SNAP only</label>
          <label>State
            <select id="state"></select>
          </label>
        </div>
        <div class="row">
          <button id="geo">Use my location</button>
          <label style="display:flex;align-items:center;gap:6px;">Radius
            <span id="radiusLabel">25</span>mi
            <input id="radius" type="range" min="1" max="100" value="25" />
          </label>
        </div>
        <div class="row" style="justify-content:space-between;">
          <div id="count">0 results</div>
          <div id="status" style="font-size:12px;color:#777;"></div>
        </div>
      </div>
      <div id="list" aria-live="polite"></div>
    </aside>
    <main id="map"></main>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
  <script>
    // why: start near Keystone, FL for your dev flow
    const DEFAULT_CENTER = [28.1, -82.6];
    const map = L.map('map').setView(DEFAULT_CENTER, 10);

    // dev tiles; replace with a paid provider for production usage
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const el = {
      q: document.getElementById('q'),
      snap: document.getElementById('snap'),
      state: document.getElementById('state'),
      radius: document.getElementById('radius'),
      radiusLabel: document.getElementById('radiusLabel'),
      geo: document.getElementById('geo'),
      apply: document.getElementById('apply'),
      count: document.getElementById('count'),
      list: document.getElementById('list'),
      status: document.getElementById('status'),
    };

    // why: provide a simple state filter without an extra endpoint
    const STATES = ["","AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY","DC"];
    el.state.innerHTML = STATES.map(s => s ? `<option value="${s}">${s}</option>` : `<option value="">All</option>`).join("");
    el.state.value = "FL"; // sane dev default

    const markers = L.layerGroup().addTo(map);
    const markerIndex = new Map(); // market_id -> marker
    let activeId = null;

    el.radius.addEventListener('input', () => el.radiusLabel.textContent = el.radius.value);
    el.apply.onclick = () => fetchAndRender();
    map.on('moveend', () => fetchAndRenderDebounced());
    el.geo.onclick = () => {
      if (!navigator.geolocation) { alert('Geolocation not available'); return; }
      navigator.geolocation.getCurrentPosition(
        p => { map.setView([p.coords.latitude, p.coords.longitude], 12); fetchAndRender(); },
        () => alert('Unable to get location')
      );
    };

    // Enter key in search triggers fetch
    el.q.addEventListener('keydown', ev => { if (ev.key === 'Enter') fetchAndRender(); });

    let debounceTimer;
    function fetchAndRenderDebounced() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(fetchAndRender, 250);
    }

    function escapeHtml(s) { return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function escapeAttr(s) { return String(s||'').replace(/"/g, '&quot;'); }

    async function fetchAndRender() {
      const center = map.getCenter();
      const radiusMiles = +el.radius.value;
      const params = new URLSearchParams({
        lat: center.lat.toFixed(6),
        lon: center.lng.toFixed(6),
        radius_miles: String(radiusMiles),
        limit: '500'
      });
      if (el.snap.checked) params.append('accepts_snap', 'true');
      const st = el.state.value.trim();
      if (st) params.append('state', st);
      const q = el.q.value.trim();
      if (q) params.append('q', q);

      const url = `/markets?${params.toString()}`;
      const stamp = Date.now();
      el.status.textContent = 'Loading…';

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        el.count.textContent = `${data.count} result${data.count===1?'':'s'}`;
        renderMap(data.items || []);
        renderList(data.items || []);
        el.status.textContent = `OK • ${new Date(stamp).toLocaleTimeString()}`;
      } catch (e) {
        console.error(e);
        el.status.textContent = 'Error';
      }
    }

    function renderMap(items) {
      markers.clearLayers();
      markerIndex.clear();
      items.forEach(r => {
        if (r.lat == null || r.lon == null) return;
        const m = L.marker([r.lat, r.lon]);
        // why: simple, readable popup content; avoid HTML injection
        const snap = r.accepts_snap === 1 || r.accepts_snap === true ? 'Yes'
                   : (r.accepts_snap === 0 ? 'No' : 'Unknown');
        const addr = [r.street, r.city, r.state, r.zip].filter(Boolean).join(', ');
        m.bindPopup(`
          <strong>${escapeHtml(r.name || 'Unknown')}</strong><br/>
          ${escapeHtml(addr)}<br/>
          SNAP: ${snap}<br/>
          ${r.website ? `<a href="${escapeAttr(r.website)}" target="_blank" rel="noopener">Website</a>` : ''}
        `);
        m.on('click', () => highlight(r.market_id));
        markers.addLayer(m);
        markerIndex.set(r.market_id, m);
      });
    }

    function renderList(items) {
      const frag = document.createDocumentFragment();
      items.forEach(r => {
        const div = document.createElement('div');
        div.className = 'item';
        div.dataset.id = r.market_id;

        const snapVal = r.accepts_snap === 1 || r.accepts_snap === true ? 'Yes'
                      : (r.accepts_snap === 0 ? 'No' : 'Unknown');
        const snapCls = snapVal === 'Yes' ? 'snap-yes' : (snapVal === 'No' ? 'snap-no' : 'snap-unk');

        const addr = [r.city, r.state].filter(Boolean).join(', ');
        const dist = (typeof r.distance_m === 'number') ? ` • ${(r.distance_m/1609.344).toFixed(1)} mi` : '';
        div.innerHTML = `
          <div class="name">${escapeHtml(r.name || 'Unknown')}
            <span class="badges">
              <span class="badge ${snapCls}">SNAP: ${snapVal}</span>
            </span>
          </div>
          <div class="meta">${escapeHtml(addr)}${dist}</div>
        `;

        // why: click centers + opens popup for quick triage
        div.addEventListener('click', () => {
          const m = markerIndex.get(r.market_id);
          if (m) { map.setView(m.getLatLng(), Math.max(map.getZoom(), 13)); m.openPopup(); }
          highlight(r.market_id);
        });

        frag.appendChild(div);
      });
      el.list.innerHTML = '';
      el.list.appendChild(frag);
      if (activeId) highlight(activeId, true);
    }

    function highlight(id, keepScroll=false) {
      activeId = id;
      // list highlight
      Array.from(el.list.children).forEach(n => n.classList.toggle('active', n.dataset.id===id));
      // optional: scroll into view
      if (!keepScroll) {
        const node = Array.from(el.list.children).find(n => n.dataset.id===id);
        if (node) node.scrollIntoView({block:'nearest'});
      }
    }

    // initial fetch
    el.radiusLabel.textContent = el.radius.value;
    fetchAndRender();
  </script>
</body>
</html>
